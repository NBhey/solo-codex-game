import{P as c}from"./vendor-phaser-CaWnzXme.js";import{y as m,a as v}from"./platform-services-ChsI6iwc.js";const d=960,p=540,F=6,q=4,L=F*q,X="triangle-arena-progress-v1",G=260,Z=560,C=3,it=180,at=92,I=240,nt=1400,rt=1100,ot=1800,ht=6,U=1700,Q=80,lt=35,ct=20,ut=4,dt=20;function tt(l){const t=Math.max(0,Math.floor(l));return lt+t*ct}function pt(l,t){const e=Math.max(0,Math.floor(l)),s=Math.max(0,Math.floor(t));return s>=Q?!1:e>=tt(s)}function N(l,t){const s=Math.max(0,Math.floor(l))*ut;return t?s+dt:s}const P={bestScore:0,totalWins:0,totalLosses:0,totalKills:0,credits:0,hpUpgradeLevel:0,soundEnabled:!0};function R(l,t){const e=Number(l);return Number.isFinite(e)?Math.max(0,Math.floor(e)):t}class yt{constructor(){this.progress={...P}}get data(){return this.progress}async load(){const t=await m.loadJson(X,{...P});this.progress=this.hydrate(t)}async save(){await m.saveJson(X,this.progress)}recordWin(t,e){const s=Math.max(0,Math.round(t)),i=Math.max(0,Math.floor(e));this.progress.totalWins+=1,this.progress.totalKills+=i,this.progress.bestScore=Math.max(this.progress.bestScore,s);const a=N(i,!0);return this.progress.credits+=a,a}recordLoss(t){this.progress.totalLosses+=1,this.progress.totalKills+=t;const e=N(t,!1);return this.progress.credits+=e,e}toggleSound(){return this.progress.soundEnabled=!this.progress.soundEnabled,this.progress.soundEnabled}getNextHpUpgradeCost(){return tt(this.progress.hpUpgradeLevel)}canPurchaseHpUpgrade(){return pt(this.progress.credits,this.progress.hpUpgradeLevel)}purchaseHpUpgrade(){if(!this.canPurchaseHpUpgrade())return!1;const t=this.getNextHpUpgradeCost();return this.progress.credits=Math.max(0,this.progress.credits-t),this.progress.hpUpgradeLevel+=1,!0}getPlayerMaxHp(t){return t+this.progress.hpUpgradeLevel}hydrate(t){return{bestScore:R(t.bestScore,P.bestScore),totalWins:R(t.totalWins,P.totalWins),totalLosses:R(t.totalLosses,P.totalLosses),totalKills:R(t.totalKills,P.totalKills),credits:R(t.credits,P.credits),hpUpgradeLevel:Math.min(Q,R(t.hpUpgradeLevel,P.hpUpgradeLevel)),soundEnabled:typeof t.soundEnabled=="boolean"?t.soundEnabled:P.soundEnabled}}}const k=new yt;function T(l,t,e){return Math.max(t,Math.min(e,l))}function S(l){return Math.round(l)}function g(l){return`${Math.max(1,Math.round(l))}px`}function B(l){const t=Math.max(1,l.scale.displaySize.width),e=Math.max(1,l.scale.displaySize.height),s=Math.min(t/d,e/p),i=T(s,.5,2.1),a=T(1/Math.sqrt(i),.82,1.16),n=l.sys.game.device.input.touch||t<=860,r=T(a*(n?1.04:1),.82,1.18);return{isMobile:n,fitScale:s,uiScale:r,margin:S(14*r),heroTitleFont:S(48*r),sceneTitleFont:S(42*r),headingFont:S(30*r),bodyFont:S(18*r),smallFont:S(15*r),hudFont:S(20*T(r,.9,1.08)),hudCompactFont:S(17*T(r,.9,1.08)),lineSpacing:S(5*r),buttonWidth:S(T(250*r,220,320)),buttonCompactWidth:S(T(190*r,160,250)),buttonHeight:S(T((n?52:46)*r,42,60)),buttonFont:S(T(19*r,16,24)),modalWidth:S(T(520*r,420,700)),modalLargeWidth:S(T(580*r,480,780))}}function ft(l=120){let t=!0,e=!1,s=null,i=0;return{setEnabled(a){t=a,a||(e=!1,s=null)},isEnabled(){return t},isPressed(){return e},pointerDown(a){return!t||s!==null||Date.now()<i?!1:(s=a,e=!0,!0)},pointerUp(a,n){if(a!==s)return!1;s=null;const r=t&&e&&n&&Date.now()>=i;return e=!1,r&&(i=Date.now()+l),r},cancelPointer(a){a===s&&(s=null,e=!1)}}}function A(l,t,e,s,i,a={}){const n=a.width??250,r=a.height??46,o=a.normalColor??2375002,h=a.hoverColor??3103880,u=a.disabledColor??4937059,x=a.textColor??"#f8fafc",M=a.fontSize??20,f=l.add.container(t,e),E=l.add.rectangle(0,0,n,r,o,1).setStrokeStyle(2,9489908,.75),W=l.add.text(0,0,s,{fontFamily:"Arial",fontSize:`${M}px`,color:x}).setOrigin(.5);f.setSize(n,r),f.add([E,W]);const V=()=>{f.setInteractive(new c.Geom.Rectangle(-n/2,-r/2,n,r),c.Geom.Rectangle.Contains),f.input&&(f.input.cursor="pointer")};V();const w=ft(),et=b=>f.getBounds().contains(b.x,b.y),H=()=>{if(!w.isEnabled()){E.setFillStyle(u,1),W.setAlpha(.8);return}E.setFillStyle(w.isPressed()?h:o,1),W.setAlpha(1)};return f.on("pointerover",()=>{w.isEnabled()&&!w.isPressed()&&E.setFillStyle(h,1)}),f.on("pointerout",b=>{w.cancelPointer(b.id),w.isEnabled()&&E.setFillStyle(o,1)}),f.on("pointerdown",(b,z,j,D)=>{D.stopPropagation(),w.pointerDown(b.id)&&E.setFillStyle(h,1)}),f.on("pointerup",(b,z,j,D)=>{D.stopPropagation();const st=w.pointerUp(b.id,et(b));H(),st&&i()}),f.on("pointerupoutside",(b,z,j,D)=>{D.stopPropagation(),w.cancelPointer(b.id),H()}),f.setEnabled=b=>{w.setEnabled(b),w.isEnabled()?V():f.disableInteractive(),H()},w.isEnabled()||f.disableInteractive(),H(),f.on("destroy",()=>{f.removeAllListeners()}),f}async function Et(l,t,e){if(Y(l,t))return;const s=await e();l.scene.add(t,s,!1)}function Y(l,t){try{return!!l.scene.get(t)}catch{return!1}}function K(l,t,e){try{return l.scene.start(t,e),!0}catch(s){console.error(`[${l.scene.key}] scene.start(${t}) failed`,s)}try{return l.scene.manager.start(t,e),!0}catch(s){console.error(`[${l.scene.key}] scene.manager.start(${t}) failed`,s)}return!1}function J(l,t){try{return l.scene.isActive(t)||l.scene.isPaused(t)||l.scene.isSleeping(t)}catch{return!1}}function O(l,t,e,s={}){const i=s.fallbackKey??"MainMenuScene",a=s.timeoutMs??1400,n=s.shouldFallback??(()=>!0);return K(l,t,e)?(globalThis.setTimeout(()=>{J(l,t)||!n()||i===t||J(l,i)||(console.error(`[${l.scene.key}] Transition watchdog fired for ${t}, fallback -> ${i}`),K(l,i))},a),!0):(K(l,i),!1)}const mt=560,gt=12;function vt(l){const t=Math.max(0,Math.floor(l)),e=Math.floor(t/q)+1;return Math.min(F,e)}function _(l){const t=vt(l),e=t-1;return{wave:t,spawnDelayMs:Math.max(mt,nt-e*120),maxEnemiesOnField:Math.min(gt,ht+Math.floor(e/2)),enemySpeedMultiplier:1+Math.min(.55,e*.08),enemyFireRateMultiplier:1+Math.min(.5,e*.07),patternWeights:{chaser:Math.max(1,6-e),strafer:2+Math.min(4,e),dasher:t>=2?1+Math.floor((t-2)/2):0}}}function St(l){const t=Math.max(320,Math.round(rt/l.enemyFireRateMultiplier)),e=Math.max(t+120,Math.round(ot/l.enemyFireRateMultiplier));return{minMs:t,maxMs:e}}function xt(l,t){const e=Object.entries(t.patternWeights),s=e.reduce((n,[,r])=>n+Math.max(0,r),0);if(s<=0)return"chaser";const i=Math.min(.999999,Math.max(0,l))*s;let a=0;for(const[n,r]of e)if(a+=Math.max(0,r),i<a)return n;return"chaser"}class Mt extends c.Scene{constructor(){super("WinScene"),this.snapshotData={},this.actionButtons=[],this.transitionInProgress=!1}create(t){this.actionButtons=[],this.transitionInProgress=!1,this.snapshotData={...t};const e=t.kills??0,s=Math.max(0,Math.round(t.score??0)),i=t.elapsedMs??0,a=t.creditsEarned??0,n=t.waveReached??1,r=!!t.reviveUsed,o=B(this);v.startMusic(),this.cameras.main.setBackgroundColor(399890),this.add.text(d/2,p*.16,"Victory!",{fontFamily:"Arial",fontSize:g(o.sceneTitleFont),color:"#86efac"}).setOrigin(.5),this.add.text(d/2,p*.34,`Kills: ${e} / ${L}
Wave reached: ${n}
Score: ${s}
Credits earned: ${a}
Time: ${(i/1e3).toFixed(1)}s${r?`
Revive used: Yes`:""}`,{fontFamily:"Arial",fontSize:g(o.bodyFont),color:"#dcfce7",align:"center",lineSpacing:o.lineSpacing}).setOrigin(.5),this.leaderboardText=this.add.text(d/2,p*.5,"Loading leaderboard preview...",{fontFamily:"Arial",fontSize:g(o.smallFont),color:"#bbf7d0",align:"center",lineSpacing:o.lineSpacing}).setOrigin(.5,0);const h=A(this,d/2,p*.79,"Start New Game",()=>{this.restartRun()},{width:o.buttonWidth,height:o.buttonHeight,fontSize:o.buttonFont}),u=A(this,d/2,p*.9,"Main Menu",()=>{this.goToMainMenu()},{width:o.buttonWidth,height:o.buttonHeight,fontSize:o.buttonFont});this.actionButtons=[h,u],this.scale.on(c.Scale.Events.RESIZE,this.handleResize,this),this.events.once(c.Scenes.Events.SHUTDOWN,()=>{this.scale.off(c.Scale.Events.RESIZE,this.handleResize,this),this.actionButtons=[],this.transitionInProgress=!1}),this.loadLeaderboardPreview()}handleResize(){!this.scene.isActive()||this.transitionInProgress||this.scene.restart(this.snapshotData)}async restartRun(){if(!this.beginTransition()||(v.playUiClick(),await m.showInterstitial(),!this.scene.isActive()))return;O(this,"GameScene",void 0,{fallbackKey:"MainMenuScene",shouldFallback:()=>this.transitionInProgress})||this.resetTransition()}goToMainMenu(){if(!this.beginTransition())return;v.playUiClick(),O(this,"MainMenuScene",void 0,{shouldFallback:()=>this.transitionInProgress})||this.resetTransition()}async loadLeaderboardPreview(){const t=await m.getLeaderboardTop(3,m.getLeaderboardName());if(!(!this.leaderboardText||!this.leaderboardText.active)){if(!t.length){this.leaderboardText.setText("Leaderboard is empty. Be the first winner!");return}this.leaderboardText.setText(["Top 3:",...t.map(e=>`${e.rank}. ${e.name} - ${e.score}`)].join(`
`))}}beginTransition(){return this.transitionInProgress||!this.scene.isActive()?!1:(this.transitionInProgress=!0,this.actionButtons.forEach(t=>t.setEnabled(!1)),!0)}resetTransition(){this.scene.isActive()&&(this.transitionInProgress=!1,this.actionButtons.forEach(t=>t.setEnabled(!0)))}}class bt extends c.Scene{constructor(){super("GameOverScene"),this.snapshotData={},this.actionButtons=[],this.transitionInProgress=!1}create(t){this.actionButtons=[],this.transitionInProgress=!1,this.snapshotData={...t};const e=t.kills??0,s=t.creditsEarned??0,i=t.waveReached??1,a=!!t.reviveUsed,n=B(this);v.startMusic(),this.cameras.main.setBackgroundColor(1641234),this.add.text(d/2,p*.28,"Game Over",{fontFamily:"Arial",fontSize:g(n.sceneTitleFont),color:"#fca5a5"}).setOrigin(.5),this.add.text(d/2,p*.41,`Kills this run: ${e}
Wave reached: ${i}
Credits earned: ${s}${a?`
Revive used: Yes`:""}`,{fontFamily:"Arial",fontSize:g(n.bodyFont),color:"#fee2e2",align:"center",lineSpacing:n.lineSpacing}).setOrigin(.5),this.statusText=this.add.text(d/2,p*.56,"",{fontFamily:"Arial",fontSize:g(n.smallFont),color:"#fde68a"}).setOrigin(.5);const r=A(this,d/2,p*.67,"Play Again",()=>{this.restartRun()},{width:n.buttonWidth,height:n.buttonHeight,fontSize:n.buttonFont}),o=A(this,d/2,p*.81,"Main Menu",()=>{this.goToMainMenu()},{width:n.buttonWidth,height:n.buttonHeight,fontSize:n.buttonFont});this.actionButtons=[r,o],this.scale.on(c.Scale.Events.RESIZE,this.handleResize,this),this.events.once(c.Scenes.Events.SHUTDOWN,()=>{this.scale.off(c.Scale.Events.RESIZE,this.handleResize,this),this.actionButtons=[],this.transitionInProgress=!1})}handleResize(){!this.scene.isActive()||this.transitionInProgress||this.scene.restart(this.snapshotData)}restartRun(){if(!this.beginTransition())return;v.playUiClick(),this.statusText?.setText("Restarting..."),O(this,"GameScene",{showInterstitialAfterRestart:!0},{fallbackKey:"MainMenuScene",shouldFallback:()=>this.transitionInProgress})||(this.statusText?.setText("Restart failed. Try again."),this.resetTransition())}goToMainMenu(){if(!this.beginTransition())return;v.playUiClick(),O(this,"MainMenuScene",void 0,{shouldFallback:()=>this.transitionInProgress})||this.resetTransition()}beginTransition(){return this.transitionInProgress||!this.scene.isActive()?!1:(this.transitionInProgress=!0,this.actionButtons.forEach(t=>t.setEnabled(!1)),!0)}resetTransition(){this.scene.isActive()&&(this.transitionInProgress=!1,this.actionButtons.forEach(t=>t.setEnabled(!0)))}}const y=class y extends c.Scene{constructor(){super("GameScene"),this.playerTextureKey="player-triangle",this.enemyBaseTextureKey="enemy-triangle",this.kills=0,this.hp=C,this.playerMaxHp=C,this.wave=1,this.waveConfig=_(0),this.lastShotAt=0,this.lastEnemyShotSfxAt=0,this.startedAt=0,this.ending=!1,this.gameplayStarted=!1,this.showInterstitialAfterRestart=!1,this.isTouchControls=!1,this.touchMovePointerId=null,this.touchMoveTarget=null,this.touchAim=new c.Math.Vector2(d/2,p/2),this.touchAimActive=!1,this.pauseState="none",this.pauseOverlayObjects=[],this.reviveOverlayObjects=[],this.reviveUsed=!1,this.reviveOfferActive=!1,this.rocketCharges=0,this.enemyKindCycle=[],this.enemyKindCycleIndex=0,this.enemyKindCycleKey=""}init(t){this.showInterstitialAfterRestart=!!t?.showInterstitialAfterRestart}create(){this.resetRuntimeState(),this.ensureEndScenesRegistered(),this.playerMaxHp=k.getPlayerMaxHp(C),this.hp=this.playerMaxHp,this.input.setDefaultCursor("crosshair"),this.removePointerListeners(),this.resolveShipTextures(),this.drawBackground(),this.player=this.physics.add.image(d/2,p/2,this.playerTextureKey),this.normalizePlayerSize(),this.player.setDrag(600,600),this.player.setMaxVelocity(G,G),this.configureCamera(),this.playerBullets=this.physics.add.group(),this.enemyBullets=this.physics.add.group(),this.enemies=this.physics.add.group(),this.pickups=this.physics.add.group(),this.ensurePickupTextures(),this.isTouchControls=this.sys.game.device.input.touch,this.setupCollisions(),this.createHud(),this.bindInput(),this.createTouchHints(),v.startMusic(),this.scale.on(c.Scale.Events.RESIZE,this.handleResize,this),this.showInterstitialAfterRestart?this.startGameplayAfterRestartAd():this.startGameplayLoop(),this.events.once(c.Scenes.Events.SHUTDOWN,()=>{m.markGameplayStop(),this.input.setDefaultCursor("default"),this.removePointerListeners(),this.spawnTimer?.remove(!1),this.pickupSpawnTimer?.remove(!1),this.pickupSpawnTimer=void 0,this.destroyPauseOverlay(),this.clearReviveOverlayObjects(),this.pauseButton?.destroy(),this.touchMoveHintRect?.destroy(),this.touchAimHintRect?.destroy(),this.touchMoveHintText?.destroy(),this.touchAimHintText?.destroy(),this.enemies?.children.each(t=>(this.destroyEnemyHpBar(t),!0)),this.backgroundGradient?.destroy(),this.backgroundGrid?.destroy(),this.backgroundGradient=void 0,this.backgroundGrid=void 0,this.scale.off(c.Scale.Events.RESIZE,this.handleResize,this)})}update(){this.handlePauseShortcuts(),!(this.ending||!this.gameplayStarted||this.pauseState!=="none")&&(this.updatePlayerMovement(),this.syncBackgroundToCamera(),this.updateEnemyAI(),this.updateBoomerangBullets(),this.cleanupPickups(),this.cleanupExpiredBullets())}resetRuntimeState(){this.kills=0,this.hp=C,this.playerMaxHp=C,this.wave=1,this.waveConfig=_(0),this.lastShotAt=0,this.lastEnemyShotSfxAt=0,this.spawnTimer=void 0,this.startedAt=0,this.ending=!1,this.gameplayStarted=!1,this.touchMovePointerId=null,this.touchMoveTarget=null,this.touchAim.set(d/2,p/2),this.touchAimActive=!1,this.pauseState="none",this.reviveUsed=!1,this.reviveOfferActive=!1,this.rocketCharges=0,this.enemyKindCycle=[],this.enemyKindCycleIndex=0,this.enemyKindCycleKey=""}resolveShipTextures(){this.playerTextureKey=this.textures.exists("player-ship")?"player-ship":"player-triangle";const t=["enemy-red-ship","enemy-yellow-ship","enemy-triangle","enemy-blue-ship","enemy-purple-ship","enemy-green-ship"];this.enemyBaseTextureKey=t.find(e=>this.textures.exists(e))??"enemy-triangle"}normalizePlayerSize(){const t=this.player.displayWidth||this.player.width,e=this.player.displayHeight||this.player.height;if(t<=0||e<=0)return;const s=Math.min(y.PLAYER_TARGET_SIZE/t,y.PLAYER_TARGET_SIZE/e);Number.isFinite(s)&&s>0&&this.player.setScale(s);const i=this.player.body;i&&i.setSize(this.player.displayWidth*.72,this.player.displayHeight*.72,!0)}drawBackground(){this.ensureBackgroundTextures(),this.backgroundGradient=this.add.tileSprite(0,0,d,p,"space-bg-gradient").setOrigin(0).setScrollFactor(0).setDepth(-40),this.backgroundGrid=this.add.tileSprite(0,0,d,p,"space-bg-grid").setOrigin(0).setScrollFactor(0).setDepth(-35).setAlpha(.78),this.syncBackgroundToCamera()}ensureBackgroundTextures(){const t=y.BG_TILE_SIZE;if(!this.textures.exists("space-bg-gradient")){const e=this.add.graphics();e.setVisible(!1),e.fillGradientStyle(593695,593695,1253435,1253435,1),e.fillRect(0,0,t,t),e.generateTexture("space-bg-gradient",t,t),e.destroy()}if(!this.textures.exists("space-bg-grid")){const e=this.add.graphics();e.setVisible(!1),e.clear(),e.fillStyle(0,0),e.fillRect(0,0,t,t),e.lineStyle(1,2045272,.72);for(let s=0;s<=t;s+=64)e.lineBetween(s,0,s,t);for(let s=0;s<=t;s+=64)e.lineBetween(0,s,t,s);e.fillStyle(14412542,.34);for(let s=0;s<20;s+=1){const i=s*53%t,a=s*89%t;e.fillCircle(i,a,s%3+1)}e.generateTexture("space-bg-grid",t,t),e.destroy()}}configureCamera(){const t=this.cameras.main;t.startFollow(this.player,!0,.16,.16),t.setDeadzone(Math.round(d*.42),Math.round(p*.32)),t.setRoundPixels(!1)}syncBackgroundToCamera(){const t=this.cameras.main,e=Math.max(1,Math.round(t.width/t.zoom)),s=Math.max(1,Math.round(t.height/t.zoom));this.backgroundGradient&&(this.backgroundGradient.setSize(e,s),this.backgroundGradient.tilePositionX=t.scrollX*.15,this.backgroundGradient.tilePositionY=t.scrollY*.15),this.backgroundGrid&&(this.backgroundGrid.setSize(e,s),this.backgroundGrid.tilePositionX=t.scrollX,this.backgroundGrid.tilePositionY=t.scrollY)}bindInput(){const t=this.input.keyboard;t&&(this.keyW=t.addKey(c.Input.Keyboard.KeyCodes.W),this.keyA=t.addKey(c.Input.Keyboard.KeyCodes.A),this.keyS=t.addKey(c.Input.Keyboard.KeyCodes.S),this.keyD=t.addKey(c.Input.Keyboard.KeyCodes.D),this.keyPause=t.addKey(c.Input.Keyboard.KeyCodes.P),this.keyEscape=t.addKey(c.Input.Keyboard.KeyCodes.ESC)),this.isTouchControls&&this.input.addPointer(2),this.input.on("pointerdown",this.onPointerDown,this),this.input.on("pointermove",this.onPointerMove,this),this.input.on("pointerup",this.onPointerUp,this),this.input.on("pointerupoutside",this.onPointerUp,this)}setupCollisions(){this.physics.add.overlap(this.playerBullets,this.enemies,this.onPlayerBulletHitsEnemy,void 0,this),this.physics.add.overlap(this.enemyBullets,this.player,this.onEnemyBulletHitsPlayer,void 0,this),this.physics.add.overlap(this.enemies,this.player,this.onEnemyTouchesPlayer,void 0,this),this.physics.add.overlap(this.player,this.pickups,this.onPlayerCollectPickup,void 0,this)}createHud(){this.killsText=this.add.text(0,0,`Kills: ${this.kills}/${L}`,{fontFamily:"Arial",fontSize:"20px",color:"#ecfeff"}).setScrollFactor(0).setDepth(20),this.hpText=this.add.text(0,0,`HP: ${this.hp}/${this.playerMaxHp}`,{fontFamily:"Arial",fontSize:"20px",color:"#dcfce7"}).setScrollFactor(0).setDepth(20),this.waveText=this.add.text(0,0,`Wave: ${this.wave}/${F}`,{fontFamily:"Arial",fontSize:"18px",color:"#bfdbfe"}).setScrollFactor(0).setDepth(20),this.creditsText=this.add.text(0,0,"Run Credits: 0",{fontFamily:"Arial",fontSize:"17px",color:"#fef3c7"}).setScrollFactor(0).setDepth(20),this.rocketsText=this.add.text(0,0,"Rockets: 0",{fontFamily:"Arial",fontSize:"17px",color:"#fecaca"}).setScrollFactor(0).setDepth(20),this.statusText=this.add.text(0,0,this.getControlsHint(),{fontFamily:"Arial",fontSize:"16px",color:"#dbeafe"}).setScrollFactor(0).setDepth(20).setOrigin(.5,0),this.updateRocketHud(),this.applyHudLayout()}applyHudLayout(){const t=B(this),e=t.margin;this.killsText.setPosition(e,e*.7),this.killsText.setFontSize(g(t.hudFont)),this.hpText.setPosition(e,e*.7+t.hudFont+4),this.hpText.setFontSize(g(t.hudFont)),this.waveText.setPosition(e,e*.7+t.hudFont*2+8),this.waveText.setFontSize(g(t.hudCompactFont)),this.creditsText.setPosition(e,e*.7+t.hudFont*2+t.hudCompactFont+12),this.creditsText.setFontSize(g(t.hudCompactFont)),this.rocketsText.setPosition(e,e*.7+t.hudFont*2+t.hudCompactFont*2+16),this.rocketsText.setFontSize(g(t.hudCompactFont)),this.statusText.setPosition(d/2,e*.7),this.statusText.setFontSize(g(t.hudCompactFont)),this.pauseButton?.destroy();const s=t.buttonCompactWidth,i=Math.max(36,t.buttonHeight-8);this.pauseButton=A(this,d-s*.5-t.margin,e+i*.5,"Pause",()=>{v.playUiClick(),this.togglePause()},{width:s,height:i,fontSize:Math.max(14,t.buttonFont-2)}),this.pauseButton.setDepth(22),this.pauseButton.setScrollFactor(0)}createTouchHints(){this.isTouchControls&&(this.touchMoveHintRect=this.add.rectangle(0,0,10,10,1981023,.16).setOrigin(0,1).setDepth(1),this.touchAimHintRect=this.add.rectangle(0,0,10,10,7023941,.16).setOrigin(0,1).setDepth(1),this.touchMoveHintRect.setScrollFactor(0),this.touchAimHintRect.setScrollFactor(0),this.touchMoveHintText=this.add.text(0,0,"Move Zone",{fontFamily:"Arial",fontSize:"14px",color:"#bfdbfe"}).setScrollFactor(0).setOrigin(.5,.5).setDepth(2),this.touchAimHintText=this.add.text(0,0,"Aim + Shoot Zone",{fontFamily:"Arial",fontSize:"14px",color:"#fecdd3"}).setScrollFactor(0).setOrigin(.5,.5).setDepth(2),this.layoutTouchHints())}layoutTouchHints(){if(!this.isTouchControls||!this.touchMoveHintRect||!this.touchAimHintRect)return;const t=B(this),e=Math.round(Math.max(82,Math.min(122,92*t.uiScale))),s=d*.5;this.touchMoveHintRect.setPosition(0,p).setSize(s,e),this.touchAimHintRect.setPosition(s,p).setSize(s,e),this.touchMoveHintText?.setPosition(s*.5,p-e*.5),this.touchMoveHintText?.setFontSize(g(Math.max(13,t.smallFont-1))),this.touchAimHintText?.setPosition(s+s*.5,p-e*.5),this.touchAimHintText?.setFontSize(g(Math.max(13,t.smallFont-1)))}handleResize(){if(this.syncBackgroundToCamera(),this.applyHudLayout(),this.layoutTouchHints(),this.pauseState==="manual"&&this.pauseOverlayObjects.length>0&&(this.destroyPauseOverlay(),this.showPauseOverlay()),this.reviveOfferActive&&this.reviveOverlayObjects.length>0){const t=this.reviveStatusText?.text??"";this.clearReviveOverlayObjects(),this.showReviveOverlay(),t&&this.reviveStatusText?.setText(t)}}updatePlayerMovement(){const t=new c.Math.Vector2(0,0);this.isTouchControls&&this.touchMoveTarget?(t.set(this.touchMoveTarget.x-this.player.x,this.touchMoveTarget.y-this.player.y),t.lengthSq()<64&&t.set(0,0)):(this.keyW?.isDown&&(t.y-=1),this.keyS?.isDown&&(t.y+=1),this.keyA?.isDown&&(t.x-=1),this.keyD?.isDown&&(t.x+=1)),t.lengthSq()>0&&t.normalize().scale(G),this.player.setVelocity(t.x,t.y);const e=this.touchAimActive?this.touchAim.x:this.input.activePointer.worldX,s=this.touchAimActive?this.touchAim.y:this.input.activePointer.worldY,i=c.Math.Angle.Between(this.player.x,this.player.y,e,s);this.player.setRotation(i+Math.PI/2)}onPointerDown(t){if(!(this.pauseState!=="none"||this.ending||!this.gameplayStarted)&&!this.isPointerOverPauseButton(t)){if(!this.isTouchControls){this.tryShoot(t.worldX,t.worldY);return}if(t.x<=d*.5){this.touchMovePointerId=t.id,this.touchMoveTarget?this.touchMoveTarget.set(t.worldX,t.worldY):this.touchMoveTarget=new c.Math.Vector2(t.worldX,t.worldY);return}this.touchAimActive=!0,this.touchAim.set(t.worldX,t.worldY),this.tryShoot(t.worldX,t.worldY)}}onPointerMove(t){if(!(!this.isTouchControls||!t.isDown||this.pauseState!=="none")){if(t.id===this.touchMovePointerId){this.touchMoveTarget?this.touchMoveTarget.set(t.worldX,t.worldY):this.touchMoveTarget=new c.Math.Vector2(t.worldX,t.worldY);return}this.touchAimActive=!0,this.touchAim.set(t.worldX,t.worldY),this.tryShoot(t.worldX,t.worldY)}}onPointerUp(t){if(this.isTouchControls){if(t.id===this.touchMovePointerId){this.touchMovePointerId=null,this.touchMoveTarget=null;return}this.touchAimActive=!1}}isPointerOverPauseButton(t){return!this.pauseButton||!this.pauseButton.visible?!1:this.pauseButton.getBounds().contains(t.x,t.y)}removePointerListeners(){this.input.off("pointerdown",this.onPointerDown,this),this.input.off("pointermove",this.onPointerMove,this),this.input.off("pointerup",this.onPointerUp,this),this.input.off("pointerupoutside",this.onPointerUp,this)}getControlsHint(){return this.isTouchControls?"Left zone: move. Right zone: aim/shoot. Use Pause anytime.":"WASD to move, LMB to shoot, P/Esc to pause."}tryShoot(t,e){!this.gameplayStarted||this.pauseState!=="none"||this.time.now-this.lastShotAt<it||(this.lastShotAt=this.time.now,this.createBullet(this.playerBullets,this.player.x,this.player.y,t,e,Z,10418082),this.fireRocketAssist(t,e),v.playShoot())}createBullet(t,e,s,i,a,n,r,o={}){const h=t.get(e,s,"bullet");if(!h)return null;h.enableBody(!0,e,s,!0,!0),h.setScale(1),h.setTint(r),h.setDepth(4),h.setData("isBoomerang",!1),h.setData("boomerangReturning",!1),h.setData("boomerangSpinDir",1),h.setData("boomerangSpeed",n),h.setData("boomerangReturnX",e),h.setData("boomerangReturnY",s),h.setData("boomerangTurnAt",0),h.setData("boomerangCurveAt",0),h.setData("isRocketAssist",!1),h.setData("damage",o.damage??1);const u=h.body;if(!u)return null;u.setAllowGravity(!1);const x=c.Math.Angle.Between(e,s,i,a);this.physics.velocityFromRotation(x,n,u.velocity),h.setRotation(x);const M=o.lifetimeMultiplier??1;return h.setData("expiresAt",this.time.now+Math.round(U*M)),h}ensurePickupTextures(){if(!this.textures.exists("pickup-rocket-dot")){const t=this.add.graphics();t.setVisible(!1),t.fillStyle(15680580,1),t.fillCircle(8,8,6),t.lineStyle(2,16557477,.95),t.strokeCircle(8,8,6),t.generateTexture("pickup-rocket-dot",16,16),t.destroy()}}spawnRocketPickup(){if(this.ending||this.pauseState!=="none"||this.pickups.countActive(!0)>0)return;const t=this.cameras.main.worldView,e=80,s=c.Math.Between(Math.round(t.left+e),Math.round(t.right-e)),i=c.Math.Between(Math.round(t.top+e),Math.round(t.bottom-e)),a=this.pickups.get(s,i,"pickup-rocket-dot");a&&(a.enableBody(!0,s,i,!0,!0),a.setDepth(5),a.setScale(1),a.setTint(16731471),a.setData("pickupType","rocket-launcher"),a.setData("expiresAt",this.time.now+y.ROCKET_PICKUP_LIFETIME_MS))}onPlayerCollectPickup(t,e){const s=t,i=e,a=this.pickups.contains(s)?s:this.pickups.contains(i)?i:null,n=s===this.player?s:i===this.player?i:null;!a||!n||!a.active||!n.active||this.ending||(a.disableBody(!0,!0),a.getData("pickupType")==="rocket-launcher"&&(this.rocketCharges+=y.ROCKET_CHARGES_PER_PICKUP,this.updateRocketHud(),this.statusText.setText(`Rocket launcher acquired: ${this.rocketCharges} charges`),this.time.delayedCall(1200,()=>{!this.ending&&this.pauseState==="none"&&this.statusText.setText(this.getControlsHint())})))}fireRocketAssist(t,e){if(this.rocketCharges<=0)return;const s=c.Math.Angle.Between(this.player.x,this.player.y,t,e),i=new c.Math.Vector2(-Math.sin(s),Math.cos(s)).scale(8),a=Z*1.42;[-1,1].forEach(n=>{const r=i.x*n,o=i.y*n,h=this.createBullet(this.playerBullets,this.player.x+r,this.player.y+o,t+r*2,e+o*2,a,16731471,{damage:2});h&&(h.setScale(.3,1.9),h.setDepth(5),h.setData("isRocketAssist",!0),h.setData("expiresAt",this.time.now+Math.round(U*1.35)))}),this.rocketCharges=Math.max(0,this.rocketCharges-1),this.updateRocketHud()}updateRocketHud(){this.rocketsText.setText(`Rockets: ${this.rocketCharges}`)}pickEnemyKind(){const t=this.getAvailableEnemyKinds(),e=t.join("|");(this.enemyKindCycle.length===0||this.enemyKindCycleIndex>=this.enemyKindCycle.length||this.enemyKindCycleKey!==e)&&(this.enemyKindCycle=c.Utils.Array.Shuffle([...t]),this.enemyKindCycleIndex=0,this.enemyKindCycleKey=e);const s=this.enemyKindCycle[this.enemyKindCycleIndex]??"standard";return this.enemyKindCycleIndex+=1,s}getAvailableEnemyKinds(){const t=["standard"];return this.waveConfig.wave>=2&&t.push("blue"),this.waveConfig.wave>=3&&t.push("purple"),this.waveConfig.wave>=4&&t.push("green"),t}getEnemyTextureForKind(t){if(t==="blue"){if(this.textures.exists("enemy-blue-ship"))return"enemy-blue-ship";if(this.textures.exists("enemy-yellow-ship"))return"enemy-yellow-ship"}if(t==="purple"){if(this.textures.exists("enemy-purple-ship"))return"enemy-purple-ship";if(this.textures.exists("enemy-red-ship"))return"enemy-red-ship"}if(t==="green"){if(this.textures.exists("enemy-green-ship"))return"enemy-green-ship";if(this.textures.exists("enemy-yellow-ship"))return"enemy-yellow-ship"}return this.textures.exists("enemy-red-ship")?"enemy-red-ship":this.textures.exists("enemy-yellow-ship")?"enemy-yellow-ship":this.enemyBaseTextureKey}getEnemyMaxHp(t){return t==="blue"?3:1}normalizeEnemySize(t,e){const s=t.width,i=t.height;if(s<=0||i<=0)return;if(t.setScale(1),e==="blue"){const n=(this.player.displayWidth||y.PLAYER_TARGET_SIZE)*1.1,r=(this.player.displayHeight||y.PLAYER_TARGET_SIZE)*1.1,o=Math.min(n/s,r/i);Number.isFinite(o)&&o>0&&t.setScale(o)}const a=t.body;a&&(a.setAllowGravity(!1),a.setSize(t.displayWidth*.72,t.displayHeight*.72,!0))}applyEnemyVisual(t,e,s){if(e==="blue"){t.setTint(6333946);return}if(e==="purple"){t.setTint(12616956);return}if(e==="green"){t.setTint(4906624);return}s==="strafer"?t.setTint(9684477):s==="dasher"?t.setTint(16569165):t.clearTint()}spawnEnemy(){if(this.ending||this.pauseState!=="none"||this.enemies.countActive(!0)>=this.waveConfig.maxEnemiesOnField)return;const t=c.Math.Between(0,3),e=this.cameras.main.worldView,s=28;let i=0,a=0;t===0?(i=e.left-s,a=c.Math.Between(Math.round(e.top+s),Math.round(e.bottom-s))):t===1?(i=e.right+s,a=c.Math.Between(Math.round(e.top+s),Math.round(e.bottom-s))):t===2?(i=c.Math.Between(Math.round(e.left+s),Math.round(e.right-s)),a=e.top-s):(i=c.Math.Between(Math.round(e.left+s),Math.round(e.right-s)),a=e.bottom+s);const n=this.pickEnemyKind(),r=this.getEnemyTextureForKind(n),o=this.enemies.get(i,a,r);if(!o)return;const h=xt(Math.random(),this.waveConfig),u=this.getEnemyMaxHp(n);o.enableBody(!0,i,a,!0,!0),o.setTexture(r),this.normalizeEnemySize(o,n),o.setDepth(3),o.setData("kind",n),o.setData("hp",u),o.setData("maxHp",u),o.setData("pattern",h),o.setData("nextShotAt",this.time.now+this.getEnemyShotDelay(h,n)),o.setData("dashAt",this.time.now+c.Math.Between(850,1800)),o.setData("dashUntil",0),this.applyEnemyVisual(o,n,h),this.attachEnemyHpBar(o)}updateEnemyAI(){this.enemies.children.each(t=>{const e=t;if(!e.active)return this.destroyEnemyHpBar(e),!0;const s=e.body;if(!s)return!0;const i=e.getData("pattern")??"chaser",a=e.getData("kind")??"standard",n=c.Math.Angle.Between(e.x,e.y,this.player.x,this.player.y),r=at*this.waveConfig.enemySpeedMultiplier;if(i==="strafer"){const h=new c.Math.Vector2(this.player.x-e.x,this.player.y-e.y),u=h.length();u>.001&&h.normalize();const x=new c.Math.Vector2(-h.y,h.x),M=u>220?.75:u<140?-.6:.12,f=h.x*r*M+x.x*r*.95,E=h.y*r*M+x.y*r*.95;s.setVelocity(f,E)}else if(i==="dasher"){const h=Number(e.getData("dashAt")??0),u=Number(e.getData("dashUntil")??0);this.time.now>=h?(this.physics.velocityFromRotation(n,r*2.4,s.velocity),e.setData("dashUntil",this.time.now+360),e.setData("dashAt",this.time.now+c.Math.Between(1300,2300))):this.time.now>=u&&this.physics.velocityFromRotation(n,r*.6,s.velocity)}else this.physics.velocityFromRotation(n,r,s.velocity);e.setRotation(n+Math.PI/2),this.updateEnemyHpBar(e);const o=Number(e.getData("nextShotAt")??0);return this.time.now>=o&&(this.shootEnemyProjectile(e,a),this.time.now-this.lastEnemyShotSfxAt>=110&&(this.lastEnemyShotSfxAt=this.time.now,v.playEnemyShoot()),e.setData("nextShotAt",this.time.now+this.getEnemyShotDelay(i,a))),!0})}shootEnemyProjectile(t,e){if(e==="purple"){this.createBoomerangShot(t);return}if(e==="green"){this.createGreenSpreadShot(t);return}const s=e==="blue"?.94:1;this.createBullet(this.enemyBullets,t.x,t.y,this.player.x,this.player.y,I*s,e==="blue"?9684477:16757940,{lifetimeMultiplier:y.ENEMY_PROJECTILE_RANGE_MULTIPLIER})}createBoomerangShot(t){const e=this.player.body,s=this.player.x+(e?.velocity.x??0)*.16,i=this.player.y+(e?.velocity.y??0)*.16,a=I*1.05,n=y.BOOMERANG_RANGE_MULTIPLIER,r=c.Math.Between(0,1)===0?-1:1,o=c.Math.Angle.Between(t.x,t.y,s,i),h=new c.Math.Vector2(-Math.sin(o),Math.cos(o)).scale(72*r),u=this.createBullet(this.enemyBullets,t.x,t.y,s,i,a,14202110,{lifetimeMultiplier:y.ENEMY_PROJECTILE_RANGE_MULTIPLIER});if(!u)return;u.setScale(1.22),u.setData("isBoomerang",!0),u.setData("boomerangReturning",!1),u.setData("boomerangSpinDir",r),u.setData("boomerangSpeed",a),u.setData("boomerangReturnX",t.x+h.x),u.setData("boomerangReturnY",t.y+h.y);const x=c.Math.Between(Math.round(260*n),Math.round(460*n)),M=c.Math.Between(180,260);u.setData("boomerangCurveAt",this.time.now+x),u.setData("boomerangTurnAt",this.time.now+x+M),u.setData("expiresAt",this.time.now+Math.round(U*(2.2*n)))}createGreenSpreadShot(t){const e=c.Math.Angle.Between(t.x,t.y,this.player.x,this.player.y),s=c.Math.DegToRad(16),i=[e-s,e,e+s],a=220;i.forEach(n=>{const r=t.x+Math.cos(n)*a,o=t.y+Math.sin(n)*a;this.createBullet(this.enemyBullets,t.x,t.y,r,o,I*.96,8843180,{lifetimeMultiplier:y.ENEMY_PROJECTILE_RANGE_MULTIPLIER})})}updateBoomerangBullets(){const t=this.time.now,e=c.Math.Clamp(this.game.loop.delta/16.6667,.6,1.8);this.enemyBullets.children.each(s=>{const i=s;if(!i.active||!i.getData("isBoomerang"))return!0;const a=i.body;if(!a)return!0;const n=Number(i.getData("boomerangSpeed")??I),r=Number(i.getData("boomerangSpinDir")??1)||1,o=Number(i.getData("boomerangCurveAt")??0),h=Number(i.getData("boomerangTurnAt")??0);let u=!!i.getData("boomerangReturning");if(!u&&t>=h&&(u=!0,i.setData("boomerangReturning",!0)),u){const x=Number(i.getData("boomerangReturnX")??i.x),M=Number(i.getData("boomerangReturnY")??i.y),E=c.Math.Angle.Between(i.x,i.y,x,M)+r*.014*e;if(this.physics.velocityFromRotation(E,n*1.15,a.velocity),c.Math.Distance.Between(i.x,i.y,x,M)<=18)return i.disableBody(!0,!0),!0}else if(t>=o){const M=Math.atan2(a.velocity.y,a.velocity.x)+r*.05*e;this.physics.velocityFromRotation(M,n,a.velocity)}return i.rotation+=r*.35*e,!0})}getEnemyShotDelay(t,e="standard"){const s=St(this.waveConfig);let i=s.minMs,a=s.maxMs;t==="strafer"&&(i*=.9,a*=.9),t==="dasher"&&(i*=1.1,a*=1.1),e==="blue"?(i*=1.05,a*=1.1):e==="purple"&&(i*=1.2,a*=1.35);const n=Math.max(240,Math.round(i)),r=Math.max(n+90,Math.round(a));return c.Math.Between(n,r)}attachEnemyHpBar(t){if(this.destroyEnemyHpBar(t),(t.getData("kind")??"standard")!=="blue")return;const s=this.add.graphics();s.setDepth(6),t.setData("hpBar",s),this.updateEnemyHpBar(t)}updateEnemyHpBar(t){const e=t.getData("hpBar");if(!e)return;if(!t.active){e.clear(),e.setVisible(!1);return}const s=Number(t.getData("hp")??1),i=Number(t.getData("maxHp")??1);if(i<=1){e.clear(),e.setVisible(!1);return}const a=26,n=5,r=c.Math.Clamp(s/i,0,1),o=t.x-a/2,h=t.y-t.displayHeight*.58-10;e.clear(),e.fillStyle(1120295,.85),e.fillRoundedRect(o,h,a,n,1),e.fillStyle(3718648,1),e.fillRoundedRect(o+1,h+1,Math.max(1,(a-2)*r),n-2,1),e.lineStyle(1,9684477,.9),e.strokeRoundedRect(o,h,a,n,1),e.setVisible(!0)}destroyEnemyHpBar(t){const e=t.getData("hpBar");e&&e.destroy(),t.setData("hpBar",void 0)}cleanupExpiredBullets(){this.cleanupGroupBullets(this.playerBullets),this.cleanupGroupBullets(this.enemyBullets)}cleanupPickups(){const t=this.time.now;this.pickups.children.each(e=>{const s=e;if(!s.active)return!0;const i=Number(s.getData("expiresAt")??0);return i>0&&t>=i&&s.disableBody(!0,!0),!0})}cleanupGroupBullets(t){const e=this.time.now;t.children.each(s=>{const i=s;if(!i.active)return!0;const a=Number(i.getData("expiresAt")??0);return a>0&&e>=a&&i.disableBody(!0,!0),!0})}onPlayerBulletHitsEnemy(t,e){const s=t,i=e,a=this.playerBullets.contains(s)?s:this.playerBullets.contains(i)?i:null,n=this.enemies.contains(s)?s:this.enemies.contains(i)?i:null;if(!a||!n||!a.active||!n.active||this.ending)return;a.disableBody(!0,!0);const r=Math.max(1,Number(a.getData("damage")??1)),o=Number(n.getData("hp")??1)-r;if(o>0){n.setData("hp",o),this.updateEnemyHpBar(n),n.setAlpha(.5),this.tweens.add({targets:n,alpha:1,duration:120,ease:"Quad.Out"});return}this.destroyEnemyHpBar(n),n.disableBody(!0,!0),this.kills+=1,this.killsText.setText(`Kills: ${this.kills}/${L}`),this.updateRunCreditsPreview(),this.recalculateWave(),this.kills>=L&&this.finishWin()}onEnemyBulletHitsPlayer(t,e){const s=t,i=e,a=this.enemyBullets.contains(s)?s:this.enemyBullets.contains(i)?i:null,n=s===this.player?s:i===this.player?i:null;!a||!n||!a.active||!n.active||this.ending||(a.disableBody(!0,!0),this.applyDamage(1))}onEnemyTouchesPlayer(t,e){const s=t,i=e,a=this.enemies.contains(s)?s:this.enemies.contains(i)?i:null,n=s===this.player?s:i===this.player?i:null;!a||!n||!a.active||!n.active||this.ending||(this.destroyEnemyHpBar(a),a.disableBody(!0,!0),this.applyDamage(1))}applyDamage(t){this.hp-=t,this.hpText.setText(`HP: ${Math.max(0,this.hp)}/${this.playerMaxHp}`),this.cameras.main.shake(100,.004),v.playHit(),this.hp<=0&&(!this.reviveUsed&&!this.reviveOfferActive?this.offerRevive():this.finishLoss())}offerRevive(){this.reviveOfferActive=!0,this.pauseGameplay("revive"),this.statusText.setText("Critical damage! One revive is available."),this.showReviveOverlay()}showReviveOverlay(){if(this.reviveOverlayObjects.length>0){this.setOverlayVisibility(this.reviveOverlayObjects,!0);return}const t=B(this),e=t.modalLargeWidth,s=Math.round(e*.5),i=40,a=this.add.rectangle(d/2,p/2,d,p,0,.72);a.setDepth(i).setScrollFactor(0);const n=this.add.rectangle(d/2,p/2,e,s,1120295,.98);n.setStrokeStyle(2,9684477,.85),n.setDepth(i+1).setScrollFactor(0);const r=this.add.text(d/2,p/2-s*.34,"Revive Available",{fontFamily:"Arial",fontSize:g(t.headingFont),color:"#f8fafc"}).setOrigin(.5).setDepth(i+2).setScrollFactor(0),o=this.add.text(d/2,p/2-s*.14,`Watch a rewarded ad to continue this run.
Only one revive can be used per run.`,{fontFamily:"Arial",fontSize:g(t.bodyFont),color:"#e2e8f0",align:"center",lineSpacing:t.lineSpacing}).setOrigin(.5).setDepth(i+2).setScrollFactor(0);this.reviveStatusText=this.add.text(d/2,p/2+s*.08,"",{fontFamily:"Arial",fontSize:g(t.smallFont),color:"#fde68a"}).setOrigin(.5).setDepth(i+2).setScrollFactor(0);const h=A(this,d/2,p/2+s*.26,"Watch Ad and Revive",()=>{this.tryRevive(h)},{width:Math.min(e-80,t.modalWidth),height:t.buttonHeight,fontSize:t.buttonFont});h.setDepth(i+2),h.setScrollFactor(0);const u=A(this,d/2,p/2+s*.42,"Give Up",()=>{v.playUiClick(),this.hideReviveOverlay(),this.finishLoss()},{width:Math.min(e-160,t.buttonWidth),height:t.buttonHeight,fontSize:t.buttonFont,normalColor:5971242,hoverColor:8330525});u.setDepth(i+2),u.setScrollFactor(0),this.reviveOverlayObjects=[a,n,r,o,this.reviveStatusText,h,u]}async tryRevive(t){t.setEnabled(!1),this.reviveStatusText?.setText("Loading rewarded ad..."),await v.unlock();const e=await m.showRewarded();if(!(!this.scene.isActive()||this.ending)){if(!e){this.reviveStatusText?.setText("Reward was not granted. Ending run..."),await this.delay(400),this.hideReviveOverlay(),this.finishLoss();return}this.reviveUsed=!0,this.reviveOfferActive=!1,this.hp=Math.max(2,Math.ceil(this.playerMaxHp*.5)),this.hpText.setText(`HP: ${this.hp}/${this.playerMaxHp}`),this.clearGroup(this.enemyBullets),this.clearGroup(this.enemies),this.hideReviveOverlay(),this.resumeGameplay(),this.statusText.setText("Revive used. Back in action."),v.playRevive(),m.trackEvent("revive_used",{kills:this.kills,wave:this.wave})}}clearGroup(t){t.children.each(e=>{const s=e;return s.active&&s.disableBody(!0,!0),t===this.enemies&&this.destroyEnemyHpBar(s),!0})}delay(t){return new Promise(e=>window.setTimeout(e,t))}async awaitWithTimeout(t,e){return await Promise.race([t,new Promise(s=>{window.setTimeout(()=>s(void 0),e)})])}ensureEndScenesRegistered(){Y(this,"WinScene")||this.scene.add("WinScene",Mt,!1),Y(this,"GameOverScene")||this.scene.add("GameOverScene",bt,!1)}startSceneSafely(t,e){K(this,t,e)}transitionWithWatchdog(t,e,s="MainMenuScene",i=1400){O(this,t,e,{fallbackKey:s,timeoutMs:i,shouldFallback:()=>this.ending})}handlePauseShortcuts(){(this.keyPause&&c.Input.Keyboard.JustDown(this.keyPause)||this.keyEscape&&c.Input.Keyboard.JustDown(this.keyEscape))&&this.togglePause()}togglePause(){if(!(this.ending||!this.gameplayStarted||this.reviveOfferActive)){if(this.pauseState==="manual"){this.resumeGameplay();return}this.pauseState==="none"&&(this.pauseGameplay("manual"),this.statusText.setText("Paused"))}}pauseGameplay(t){this.pauseState!==t&&(this.pauseState=t,this.physics.world.pause(),this.spawnTimer&&(this.spawnTimer.paused=!0),m.markGameplayStop(),t==="manual"&&this.showPauseOverlay())}resumeGameplay(){if(this.pauseState==="none"||this.ending)return;const t=this.pauseState==="manual";this.pauseState="none",this.physics.world.resume(),this.spawnTimer&&(this.spawnTimer.paused=!1),m.markGameplayStart(),t&&(this.hidePauseOverlay(),this.statusText.setText(this.getControlsHint()))}showPauseOverlay(){if(this.pauseOverlayObjects.length>0){this.setOverlayVisibility(this.pauseOverlayObjects,!0);return}const t=B(this),e=t.modalWidth,s=Math.round(e*.52),i=35,a=this.add.rectangle(d/2,p/2,d,p,0,.62);a.setDepth(i).setScrollFactor(0);const n=this.add.rectangle(d/2,p/2,e,s,1120295,.97);n.setStrokeStyle(2,9684477,.8),n.setDepth(i+1).setScrollFactor(0);const r=this.add.text(d/2,p/2-s*.28,"Paused",{fontFamily:"Arial",fontSize:g(t.sceneTitleFont),color:"#f8fafc"}).setOrigin(.5).setDepth(i+2).setScrollFactor(0),o=A(this,d/2,p/2+s*.02,"Resume",()=>{v.playUiClick(),this.resumeGameplay()},{width:t.buttonWidth,height:t.buttonHeight,fontSize:t.buttonFont});o.setDepth(i+2),o.setScrollFactor(0);const h=A(this,d/2,p/2+s*.28,"Main Menu",()=>{this.ending||(v.playUiClick(),this.ending=!0,h.setEnabled(!1),o.setEnabled(!1),this.stopGameplayObjects(),this.transitionWithWatchdog("MainMenuScene"))},{width:t.buttonWidth,height:t.buttonHeight,fontSize:t.buttonFont});h.setDepth(i+2),h.setScrollFactor(0),this.pauseOverlayObjects=[a,n,r,o,h]}hidePauseOverlay(){this.setOverlayVisibility(this.pauseOverlayObjects,!1)}setOverlayVisibility(t,e){t.forEach(s=>{s.setVisible?.(e)})}destroyPauseOverlay(){this.pauseOverlayObjects.forEach(t=>t.destroy()),this.pauseOverlayObjects=[]}clearReviveOverlayObjects(){this.reviveOverlayObjects.forEach(t=>t.destroy()),this.reviveOverlayObjects=[],this.reviveStatusText=void 0}hideReviveOverlay(){this.clearReviveOverlayObjects(),this.reviveOfferActive=!1}stopGameplayObjects(){this.spawnTimer?.remove(!1),this.spawnTimer=void 0,this.pickupSpawnTimer?.remove(!1),this.pickupSpawnTimer=void 0,this.removePointerListeners(),this.gameplayStarted=!1,this.pauseState="none",this.physics.world.resume(),this.hidePauseOverlay(),this.hideReviveOverlay(),this.player.setVelocity(0,0),this.enemies.children.each(t=>{const e=t;return e.active&&e.setVelocity(0,0),this.destroyEnemyHpBar(e),!0}),this.clearGroup(this.pickups)}startGameplayLoop(){this.waveConfig=_(this.kills),this.wave=this.waveConfig.wave,this.waveText.setText(`Wave: ${this.wave}/${F}`),this.recreateSpawnTimer(),this.startedAt=this.time.now,this.gameplayStarted=!0,this.statusText.setText(this.getControlsHint()),this.updateRunCreditsPreview(),this.updateRocketHud(),this.pickupSpawnTimer?.remove(!1),this.pickupSpawnTimer=this.time.addEvent({delay:y.ROCKET_PICKUP_SPAWN_MS,loop:!0,callback:()=>this.spawnRocketPickup()}),m.markGameplayStart(),m.trackEvent("start_run",{hp_max:this.playerMaxHp,hp_upgrade_level:k.data.hpUpgradeLevel,controls:this.isTouchControls?"touch":"keyboard"})}recreateSpawnTimer(){const t=this.pauseState!=="none";this.spawnTimer?.remove(!1),this.spawnTimer=this.time.addEvent({delay:this.waveConfig.spawnDelayMs,loop:!0,callback:()=>this.spawnEnemy()}),this.spawnTimer.paused=t}updateRunCreditsPreview(){this.creditsText.setText(`Run Credits: ${N(this.kills,!1)}`)}recalculateWave(){const t=this.wave,e=_(this.kills),s=e.wave!==t,i=e.spawnDelayMs!==this.waveConfig.spawnDelayMs;this.waveConfig=e,this.wave=e.wave,this.waveText.setText(`Wave: ${this.wave}/${F}`),i&&this.gameplayStarted&&this.recreateSpawnTimer(),s&&(this.statusText.setText(`Wave ${this.wave} engaged!`),this.time.delayedCall(900,()=>{!this.ending&&this.pauseState==="none"&&this.statusText.setText(this.getControlsHint())}))}async startGameplayAfterRestartAd(){this.statusText.setText("Restarting. Showing ad..."),await m.showInterstitial(),!(!this.scene.isActive()||this.ending)&&this.startGameplayLoop()}async finishLoss(){if(!this.ending){this.ending=!0;try{this.statusText.setText("Defeat..."),this.stopGameplayObjects(),m.markGameplayStop();const t=k.recordLoss(this.kills);if(await this.awaitWithTimeout(k.save(),1400),m.trackEvent("loss",{kills:this.kills,wave:this.wave,credits_earned:t,revive_used:this.reviveUsed}),await this.awaitWithTimeout(m.showInterstitial().catch(s=>(console.error("[GameScene] Failed to show interstitial after loss",s),!1)),4e3),!this.scene.isActive())return;const e={kills:this.kills,creditsEarned:t,waveReached:this.wave,reviveUsed:this.reviveUsed};this.transitionWithWatchdog("GameOverScene",e)}catch(t){console.error("[GameScene] Failed to finish loss flow",t),this.startSceneSafely("MainMenuScene")}}}async finishWin(){if(!this.ending){this.ending=!0;try{this.statusText.setText("Victory!"),this.stopGameplayObjects(),m.markGameplayStop();const t=Math.max(1,this.time.now-this.startedAt),e=Math.max(1,Math.round(12e4-t)),s=k.recordWin(e,this.kills);if(await this.awaitWithTimeout(k.save(),1400),await this.awaitWithTimeout(m.submitScore(e),1800),v.playWin(),m.trackEvent("win",{kills:this.kills,wave:this.wave,score:e,elapsed_ms:t,credits_earned:s,revive_used:this.reviveUsed}),!this.scene.isActive())return;const i={kills:this.kills,score:e,elapsedMs:t,creditsEarned:s,waveReached:this.wave,reviveUsed:this.reviveUsed};this.transitionWithWatchdog("WinScene",i)}catch(t){console.error("[GameScene] Failed to finish win flow",t),this.startSceneSafely("MainMenuScene")}}}};y.PLAYER_TARGET_SIZE=40,y.BG_TILE_SIZE=256,y.ENEMY_PROJECTILE_RANGE_MULTIPLIER=1.2,y.BOOMERANG_RANGE_MULTIPLIER=3.2,y.ROCKET_PICKUP_SPAWN_MS=16500,y.ROCKET_PICKUP_LIFETIME_MS=12e3,y.ROCKET_CHARGES_PER_PICKUP=6;let $=y;const Pt=Object.freeze(Object.defineProperty({__proto__:null,GameScene:$},Symbol.toStringTag,{value:"Module"}));export{d as G,Q as M,p as a,k as b,A as c,Pt as d,Et as e,B as g,g as p};
