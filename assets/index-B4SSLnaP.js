const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./gameplay-scenes-D0kkadma.js","./vendor-phaser-CaWnzXme.js","./platform-services-ChsI6iwc.js"])))=>i.map(i=>d[i]);
import{P as y}from"./vendor-phaser-CaWnzXme.js";import{g as E,G as c,a as d,p as S,b as f,c as v,M as F,e as k}from"./gameplay-scenes-D0kkadma.js";import{y as T,a as m}from"./platform-services-ChsI6iwc.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class H extends y.Scene{constructor(){super("BootScene")}create(){const e=E(this);this.cameras.main.setBackgroundColor(725024),this.add.text(c/2,d/2-16,"Booting...",{fontFamily:"Arial",fontSize:S(e.headingFont),color:"#e2e8f0"}).setOrigin(.5),this.bootstrap()}async bootstrap(){try{await T.init(),await f.load(),m.setEnabled(f.data.soundEnabled)}catch(e){console.error("[BootScene] Startup failed:",e)}finally{this.scene.start("PreloaderScene")}}}class O extends y.Scene{constructor(){super("PreloaderScene"),this.shipsLoadFailed=!1}preload(){this.load.image("ships-sheet","assets/ships.png"),this.load.image("player-ship","assets/player-ship.png"),this.load.image("enemy-red-ship","assets/enemy-red-ship.png"),this.load.image("enemy-yellow-ship","assets/enemy-yellow-ship.png"),this.load.image("enemy-blue-ship","assets/LargeBlueShip.png"),this.load.image("enemy-purple-ship","assets/enemy-purple-ship.png"),this.load.image("enemy-green-ship","assets/enemy-green-ship.png"),this.load.on(y.Loader.Events.FILE_LOAD_ERROR,e=>{e.key==="ships-sheet"&&(this.shipsLoadFailed=!0)})}create(){const e=E(this);this.cameras.main.setBackgroundColor(988970),this.add.text(c/2,d/2,"Preloading assets...",{fontFamily:"Arial",fontSize:S(e.headingFont),color:"#cbd5e1"}).setOrigin(.5);const t=this.hasAllShipTextures(),s=!t&&!this.shipsLoadFailed&&this.textures.exists("ships-sheet")&&this.createShipTexturesFromSheet();!t&&!s&&this.createGeometryTextures(),this.ensureVariantEnemyTextures(),this.ensureBulletTexture(),T.markLoadingReady(),this.scene.start("MainMenuScene")}hasAllShipTextures(){return this.textures.exists("player-ship")&&this.textures.exists("enemy-red-ship")&&this.textures.exists("enemy-yellow-ship")}createShipTexturesFromSheet(){const e=this.textures.get("ships-sheet").getSourceImage();if(!e)return!1;const t=this.getSourceDimensions(e),s=this.getSourceImageData(e,t.width,t.height);if(!s)return!1;const n=this.getBackgroundColor(s.data,t.width,t.height),i=this.detectTargetShipBounds(s.data,t.width,t.height,n);return i?i.every(a=>this.createTextureFromBounds(e,a.key,a.bounds,n)):[{key:"player-ship",x:348,y:4,w:84,h:60},{key:"enemy-red-ship",x:348,y:150,w:84,h:60},{key:"enemy-yellow-ship",x:348,y:296,w:84,h:60}].every(a=>this.createTextureFromCrop(e,a,n))}createTextureFromCrop(e,t,s){if(this.textures.exists(t.key))return!0;const n=this.textures.createCanvas(t.key,t.w,t.h);if(!n)return!1;const i=n.getContext();i.clearRect(0,0,t.w,t.h),i.drawImage(e,t.x,t.y,t.w,t.h,0,0,t.w,t.h);const r=i.getImageData(0,0,t.w,t.h);return this.applyChromaKey(r.data,s),i.putImageData(r,0,0),n.refresh(),!0}createTextureFromBounds(e,t,s,n){const r=Math.max(0,s.minX-2),a=Math.max(0,s.minY-2),l=this.getSourceDimensions(e),o=Math.min(l.width-r,s.maxX-s.minX+1+2*2),h=Math.min(l.height-a,s.maxY-s.minY+1+2*2);return this.createTextureFromCrop(e,{key:t,x:r,y:a,w:o,h},n)}detectTargetShipBounds(e,t,s,n){const i=this.createForegroundMask(e,t,s,n),r=this.findConnectedComponents(i,t,s).filter(o=>o.area>=280&&o.maxX-o.minX+1>=26&&o.maxY-o.minY+1>=22);if(!r.length)return null;const a=[{key:"player-ship",minY:0,maxY:s/3},{key:"enemy-red-ship",minY:s/3,maxY:s*2/3},{key:"enemy-yellow-ship",minY:s*2/3,maxY:s}],l=[];for(const o of a){const h=r.filter(p=>p.centerY>=o.minY&&p.centerY<o.maxY&&p.maxX-p.minX+1>=42&&p.maxY-p.minY+1>=30);if(!h.length)return null;const b=h.sort((p,u)=>u.maxX-p.maxX||u.area-p.area)[0];l.push({key:o.key,bounds:b})}return l}createForegroundMask(e,t,s,n){const i=new Uint8Array(t*s);for(let r=0,a=0;r<e.length;r+=4,a+=1){if(e[r+3]===0)continue;const l=Math.abs(e[r]-n.r),o=Math.abs(e[r+1]-n.g),h=Math.abs(e[r+2]-n.b);(l>22||o>22||h>22)&&(i[a]=1)}return i}findConnectedComponents(e,t,s){const n=[];for(let i=0;i<e.length;i+=1){if(e[i]===0)continue;e[i]=0;const r=[i];let a=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,b=0;for(;r.length>0;){const p=r.pop(),u=p%t,g=Math.floor(p/t);b+=1,u<a&&(a=u),g<l&&(l=g),u>o&&(o=u),g>h&&(h=g);const x=u>0?p-1:-1,L=u<t-1?p+1:-1,C=g>0?p-t:-1,M=g<s-1?p+t:-1;x>=0&&e[x]===1&&(e[x]=0,r.push(x)),L>=0&&e[L]===1&&(e[L]=0,r.push(L)),C>=0&&e[C]===1&&(e[C]=0,r.push(C)),M>=0&&e[M]===1&&(e[M]=0,r.push(M))}n.push({minX:a,minY:l,maxX:o,maxY:h,area:b,centerY:(l+h)/2})}return n}getSourceDimensions(e){return{width:e.width,height:e.height}}getSourceImageData(e,t,s){if(typeof document>"u")return null;const n=document.createElement("canvas");n.width=t,n.height=s;const i=n.getContext("2d");return i?(i.clearRect(0,0,t,s),i.drawImage(e,0,0,t,s),i.getImageData(0,0,t,s)):null}getBackgroundColor(e,t,s){const n=[this.readPixel(e,t,0,0),this.readPixel(e,t,t-1,0),this.readPixel(e,t,0,s-1),this.readPixel(e,t,t-1,s-1)];return{r:Math.round((n[0].r+n[1].r+n[2].r+n[3].r)/4),g:Math.round((n[0].g+n[1].g+n[2].g+n[3].g)/4),b:Math.round((n[0].b+n[1].b+n[2].b+n[3].b)/4)}}readPixel(e,t,s,n){const i=(n*t+s)*4;return{r:e[i],g:e[i+1],b:e[i+2]}}applyChromaKey(e,t){for(let s=0;s<e.length;s+=4){const n=Math.abs(e[s]-t.r),i=Math.abs(e[s+1]-t.g),r=Math.abs(e[s+2]-t.b);n<=22&&i<=22&&r<=22&&(e[s+3]=0)}}createGeometryTextures(){const e=this.add.graphics();e.setVisible(!1),this.textures.exists("player-triangle")||(e.clear(),e.fillStyle(3066993,1),e.fillTriangle(20,2,2,38,38,38),e.generateTexture("player-triangle",40,40)),this.textures.exists("enemy-triangle")||(e.clear(),e.fillStyle(15680580,1),e.fillTriangle(20,2,2,38,38,38),e.generateTexture("enemy-triangle",40,40)),e.destroy()}ensureVariantEnemyTextures(){this.ensureTintedEnemyTexture("enemy-blue-ship",6333946),this.ensureTintedEnemyTexture("enemy-purple-ship",12616956),this.ensureTintedEnemyTexture("enemy-green-ship",4906624)}ensureTintedEnemyTexture(e,t){if(this.textures.exists(e))return;const s=this.getEnemyBaseTextureKey();if(!s)return;const n=this.textures.get(s).getSourceImage();if(!n)return;const{width:i,height:r}=this.getSourceDimensions(n),a=this.textures.createCanvas(e,i,r);if(!a)return;const l=a.getContext(),o=`#${t.toString(16).padStart(6,"0")}`;l.clearRect(0,0,i,r),l.drawImage(n,0,0,i,r),l.globalCompositeOperation="source-atop",l.fillStyle=o,l.fillRect(0,0,i,r),l.globalCompositeOperation="source-over",a.refresh()}getEnemyBaseTextureKey(){return this.textures.exists("enemy-red-ship")?"enemy-red-ship":this.textures.exists("enemy-yellow-ship")?"enemy-yellow-ship":this.textures.exists("enemy-triangle")?"enemy-triangle":null}ensureBulletTexture(){if(this.textures.exists("bullet"))return;const e=this.add.graphics();e.setVisible(!1),e.clear(),e.fillStyle(16777215,1),e.fillCircle(6,6,6),e.generateTexture("bullet",12,12),e.destroy()}}const A="modulepreload",B=function(w,e){return new URL(w,e).href},I={},U=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){const r=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),l=a?.nonce||a?.getAttribute("nonce");n=Promise.allSettled(t.map(o=>{if(o=B(o,s),o in I)return;I[o]=!0;const h=o.endsWith(".css"),b=h?'[rel="stylesheet"]':"";if(!!s)for(let g=r.length-1;g>=0;g--){const x=r[g];if(x.href===o&&(!h||x.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${b}`))return;const u=document.createElement("link");if(u.rel=h?"stylesheet":A,h||(u.as="script"),u.crossOrigin="",u.href=o,l&&u.setAttribute("nonce",l),document.head.appendChild(u),h)return new Promise((g,x)=>{u.addEventListener("load",g),u.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${o}`)))})}))}function i(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return n.then(r=>{for(const a of r||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};class N extends y.Scene{constructor(){super("MainMenuScene"),this.modalObjects=[]}create(){const e=E(this);this.drawBackground(),m.startMusic(),this.add.text(c/2,88,"Triangle Arena",{fontFamily:"Arial",fontSize:S(e.heroTitleFont),color:"#f8fafc"}).setOrigin(.5),this.statsText=this.add.text(e.margin+8,e.margin+4,this.buildStatsText(),{fontFamily:"Arial",fontSize:S(e.bodyFont),color:"#cbd5e1",lineSpacing:e.lineSpacing});const t=d*.44,s=e.buttonHeight+e.margin+4;v(this,c/2,t,"Start",()=>{this.startGame()},{width:e.buttonWidth,height:e.buttonHeight,fontSize:e.buttonFont}),v(this,c/2,t+s,"Leaderboard",()=>{this.showLeaderboard()},{width:e.buttonWidth,height:e.buttonHeight,fontSize:e.buttonFont}),v(this,c/2,t+s*2,"Upgrade Hull",()=>{this.tryPurchaseHullUpgrade()},{width:e.buttonWidth,height:e.buttonHeight,fontSize:e.buttonFont}),v(this,c/2,t+s*3,"Settings",()=>{this.showSettings()},{width:e.buttonWidth,height:e.buttonHeight,fontSize:e.buttonFont}),this.menuStatusText=this.add.text(c/2,t+s*3+e.buttonHeight*.9,this.hpUpgradeLabel(),{fontFamily:"Arial",fontSize:S(e.smallFont),color:"#bfdbfe",align:"center",lineSpacing:e.lineSpacing}).setOrigin(.5,0),this.scale.on(y.Scale.Events.RESIZE,this.handleResize,this),this.events.once(y.Scenes.Events.SHUTDOWN,()=>{this.scale.off(y.Scale.Events.RESIZE,this.handleResize,this),this.clearModal()})}handleResize(){this.scene.isActive()&&this.scene.restart()}drawBackground(){const e=this.add.graphics();e.fillGradientStyle(725024,725024,1384763,1384763,1),e.fillRect(0,0,c,d),e.fillStyle(2043730,.25),e.fillCircle(90,80,110),e.fillCircle(c-70,d-80,140)}buildStatsText(){const e=f.data,t=T.isMockMode()?"Mock SDK":"Yandex SDK",s=e.hpUpgradeLevel>=F?`+${e.hpUpgradeLevel} HP (MAX)`:`+${e.hpUpgradeLevel} HP (next: ${f.getNextHpUpgradeCost()} credits)`;return[`SDK: ${t}`,`Best Score: ${e.bestScore}`,`Wins: ${e.totalWins}`,`Losses: ${e.totalLosses}`,`Total Kills: ${e.totalKills}`,`Credits: ${e.credits}`,`Hull Upgrade: ${s}`].join(`
`)}refreshStats(){this.statsText&&this.statsText.setText(this.buildStatsText())}async startGame(){m.playUiClick(),await m.unlock(),await k(this,"GameScene",async()=>(await U(async()=>{const{GameScene:e}=await import("./gameplay-scenes-D0kkadma.js").then(t=>t.d);return{GameScene:e}},__vite__mapDeps([0,1,2]),import.meta.url)).GameScene),await T.showInterstitial(),this.scene.start("GameScene")}async showLeaderboard(){m.playUiClick(),this.clearModal();const e=E(this),t=e.modalWidth,s=Math.round(t*.58),n=this.add.rectangle(c/2,d/2,c,d,0,.65);n.setInteractive({useHandCursor:!0});const i=this.add.rectangle(c/2,d/2,t,s,1120295,.98);i.setStrokeStyle(2,9684477,.8);const r=this.add.text(c/2,d/2-s*.38,"Leaderboard",{fontFamily:"Arial",fontSize:S(e.headingFont),color:"#f8fafc"}).setOrigin(.5),a=this.add.text(c/2,d/2-s*.2,"Loading leaderboard...",{fontFamily:"Arial",fontSize:S(e.bodyFont),color:"#e2e8f0",align:"center",lineSpacing:e.lineSpacing}).setOrigin(.5,0),l=v(this,c/2,d/2+s*.36,"Close",()=>{m.playUiClick(),this.clearModal()},{width:Math.min(e.buttonWidth,t-120),height:e.buttonHeight,fontSize:e.buttonFont});this.modalObjects.push(n,i,r,a,l);const o=await T.getLeaderboardTop(5,T.getLeaderboardName());if(!(!this.scene.isActive()||!a.active)){if(!o.length){a.setText(`Leaderboard is empty yet.
Win a run to submit your score.`);return}a.setText(o.map(h=>`${h.rank}. ${h.name} - ${h.score}`).join(`
`))}}showSettings(){m.playUiClick(),this.clearModal();const e=E(this),t=e.modalLargeWidth,s=Math.min(d-e.margin*2,Math.round(t*.52)),n=this.add.rectangle(c/2,d/2,c,d,0,.65);n.setInteractive({useHandCursor:!0});const i=this.add.rectangle(c/2,d/2,t,s,1120295,.98);i.setStrokeStyle(2,9684477,.8);const r=this.add.text(c/2,d/2-s*.33,"Settings",{fontFamily:"Arial",fontSize:S(e.headingFont),color:"#f8fafc"}).setOrigin(.5),a=this.add.text(c/2,d/2-s*.1,this.soundLabel(),{fontFamily:"Arial",fontSize:S(e.bodyFont),color:"#e2e8f0"}).setOrigin(.5),l=Math.min(t-96,e.buttonWidth-18),o=Math.max(34,e.buttonHeight-10),h=Math.max(14,e.buttonFont-2),b=v(this,c/2,d/2+s*.12,"Toggle Sound",()=>{const u=f.toggleSound();m.setEnabled(u),m.playUiClick(),f.save(),a.setText(this.soundLabel()),this.refreshStats()},{width:l,height:o,fontSize:h}),p=v(this,c/2,d/2+s*.32,"Close",()=>{m.playUiClick(),this.clearModal()},{width:l,height:o,fontSize:h});this.modalObjects.push(n,i,r,a,b,p)}tryPurchaseHullUpgrade(){if(m.playUiClick(),!f.purchaseHpUpgrade()){this.menuStatusText?.setColor("#fca5a5"),this.menuStatusText?.setText(this.hpUpgradeLabel("Not enough credits or upgrade is already maxed."));return}f.save(),this.refreshStats(),this.menuStatusText?.setColor("#86efac"),this.menuStatusText?.setText(this.hpUpgradeLabel("Upgrade purchased. +1 max HP will apply next run."))}soundLabel(){return`Sound: ${f.data.soundEnabled?"ON":"OFF"}`}hpUpgradeLabel(e=""){const{hpUpgradeLevel:t}=f.data,s=t>=F?`Hull Upgrade: +${t} HP (MAXED)`:`Hull Upgrade: +${t} HP
Cost: ${f.getNextHpUpgradeCost()} credits`;return e?`${s}
${e}`:s}clearModal(){this.modalObjects.forEach(e=>e.destroy()),this.modalObjects=[]}}const P="orientation-guard-overlay";class Y{constructor(e){this.blocked=!1,this.evaluate=()=>{this.game.scale.refresh();const t=this.isPhoneLike()&&this.isPortrait();if(t!==this.blocked){if(this.blocked=t,this.blocked){this.overlay.style.display="flex",this.game.loop.sleep();return}this.overlay.style.display="none",this.game.loop.wake()}},this.game=e,this.overlay=this.ensureOverlay(),window.addEventListener("resize",this.evaluate,{passive:!0}),window.addEventListener("orientationchange",this.evaluate,{passive:!0}),window.screen.orientation?.addEventListener&&window.screen.orientation.addEventListener("change",this.evaluate),this.evaluate()}destroy(){window.removeEventListener("resize",this.evaluate),window.removeEventListener("orientationchange",this.evaluate),window.screen.orientation?.removeEventListener&&window.screen.orientation.removeEventListener("change",this.evaluate),this.overlay.remove()}isPhoneLike(){const e=Math.min(window.innerWidth,window.innerHeight);return window.matchMedia("(pointer: coarse)").matches&&e<=900}isPortrait(){return window.innerHeight>window.innerWidth}ensureOverlay(){const e=document.getElementById(P);if(e)return e;const t=document.createElement("div");t.id=P,t.setAttribute("aria-live","polite"),t.style.position="fixed",t.style.inset="0",t.style.display="none",t.style.flexDirection="column",t.style.justifyContent="center",t.style.alignItems="center",t.style.gap="14px",t.style.padding="24px",t.style.background="rgba(5, 10, 28, 0.95)",t.style.backdropFilter="blur(4px)",t.style.zIndex="10000",t.style.pointerEvents="all",t.style.textAlign="center",t.style.color="#e5edf8",t.style.fontFamily="Arial, sans-serif";const s=document.createElement("div");s.textContent="Поверните устройство горизонтально",s.style.fontSize="clamp(22px, 5vw, 34px)",s.style.fontWeight="700",s.style.letterSpacing="0.02em";const n=document.createElement("div");return n.textContent="Landscape mode is required to continue.",n.style.fontSize="clamp(14px, 3.2vw, 20px)",n.style.opacity="0.9",t.append(s,n),document.body.appendChild(t),t}}const R={type:y.AUTO,parent:"app",width:c,height:d,backgroundColor:"#0b1020",scene:[H,O,N],physics:{default:"arcade",arcade:{debug:!1}},scale:{mode:y.Scale.FIT,expandParent:!0,autoCenter:y.Scale.CENTER_BOTH,width:c,height:d}},z=new y.Game(R),D=new Y(z);window.addEventListener("beforeunload",()=>{D.destroy()});
