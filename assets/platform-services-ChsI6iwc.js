class w{constructor(){this.enabled=!0,this.musicTimerId=null,this.musicStep=0,this.musicRequested=!1}isEnabled(){return this.enabled}setEnabled(e){if(this.enabled=e,this.syncMasterGain(),!e){this.stopMusic();return}this.musicRequested&&this.startMusic()}async unlock(){const e=this.ensureContext();if(!(!e||e.state!=="suspended"))try{await e.resume()}catch{}}startMusic(){if(this.musicRequested=!0,!this.enabled||this.musicTimerId!==null)return;this.unlock();const e=[220,261.63,329.63,293.66,246.94,329.63,392,293.66];this.musicTimerId=window.setInterval(()=>{const t=e[this.musicStep%e.length];this.playTone({frequency:t,durationMs:220,volume:.038,waveform:"triangle"}),this.musicStep%2===0&&this.playTone({frequency:t*.5,durationMs:190,volume:.022,waveform:"sine",delayMs:40}),this.musicStep+=1},280)}stopMusic(){this.musicTimerId!==null&&(window.clearInterval(this.musicTimerId),this.musicTimerId=null)}playUiClick(){this.playTone({frequency:700,durationMs:70,volume:.05,waveform:"square"})}playShoot(){this.playTone({frequency:560,durationMs:80,volume:.06,waveform:"sawtooth"})}playEnemyShoot(){this.playTone({frequency:290,durationMs:90,volume:.05,waveform:"square"})}playHit(){this.playTone({frequency:170,durationMs:150,volume:.08,waveform:"sawtooth"})}playRevive(){this.playTone({frequency:440,durationMs:130,volume:.07,waveform:"triangle"}),this.playTone({frequency:660,durationMs:180,volume:.06,waveform:"triangle",delayMs:120})}playWin(){this.playTone({frequency:523.25,durationMs:120,volume:.06,waveform:"triangle"}),this.playTone({frequency:659.25,durationMs:140,volume:.06,waveform:"triangle",delayMs:130}),this.playTone({frequency:783.99,durationMs:190,volume:.06,waveform:"triangle",delayMs:260})}playTone(e){if(!this.enabled)return;const t=this.ensureContext(),a=this.masterGain;if(!t||!a)return;const r=t.createOscillator(),i=t.createGain(),c=(e.delayMs??0)/1e3,o=t.currentTime+c,l=Math.max(.02,e.durationMs/1e3),u=o+l,h=Math.max(1e-4,e.volume),m=o+Math.min(.02,l*.35);r.type=e.waveform,r.frequency.setValueAtTime(e.frequency,o),i.gain.setValueAtTime(1e-4,o),i.gain.exponentialRampToValueAtTime(h,m),i.gain.exponentialRampToValueAtTime(1e-4,u),r.connect(i),i.connect(a),r.start(o),r.stop(u+.01)}ensureContext(){if(typeof window>"u")return;if(this.context)return this.context;const e=window.AudioContext??window.webkitAudioContext;if(e)return this.context=new e,this.masterGain=this.context.createGain(),this.masterGain.connect(this.context.destination),this.syncMasterGain(),this.context}syncMasterGain(){if(!this.masterGain||!this.context)return;const e=this.context.currentTime;this.masterGain.gain.cancelScheduledValues(e),this.masterGain.gain.setTargetAtTime(this.enabled?.7:1e-4,e,.05)}}const f=new w,n="triangle_arena_speed",s=class s{constructor(){this.initialized=!1,this.mockMode=!1,this.gameplayMarked=!1}async init(){if(this.initialized)return;try{await this.ensureSdkScriptLoaded()}catch(t){console.warn("[YandexService] Failed to load /sdk.js, switching to mock mode.",t),this.enableMockMode("SDK script load failed");return}if(!await this.waitForYaGamesGlobal(5e3)||!window.YaGames){this.enableMockMode("YaGames global is not available");return}try{this.sdk=await window.YaGames.init(),this.player=await this.safeAwait(()=>this.sdk?.getPlayer?.()),this.storage=await this.safeAwait(()=>this.sdk?.getStorage?.()),this.initialized=!0}catch(t){console.warn("[YandexService] Failed to initialize SDK, switching to mock mode.",t),this.enableMockMode("SDK init failed")}}isReady(){return this.initialized}isMockMode(){return this.mockMode}getLeaderboardName(){return n}markLoadingReady(){if(!this.mockMode)try{this.sdk?.features?.LoadingAPI?.ready?.()}catch(e){console.warn("[YandexService] LoadingAPI.ready failed",e)}}markGameplayStart(){if(!(this.mockMode||this.gameplayMarked))try{this.sdk?.features?.GameplayAPI?.start?.(),this.gameplayMarked=!0}catch(e){this.gameplayMarked=!1,console.warn("[YandexService] GameplayAPI.start failed",e)}}markGameplayStop(){if(!(this.mockMode||!this.gameplayMarked)){this.gameplayMarked=!1;try{this.sdk?.features?.GameplayAPI?.stop?.()}catch(e){console.warn("[YandexService] GameplayAPI.stop failed",e)}}}async showInterstitial(){return this.mockMode||!this.sdk?.adv?.showFullscreenAdv?this.runMockInterstitial():new Promise(e=>{let t=!1;const a=window.setTimeout(()=>{t||(t=!0,e(!1))},3500);try{this.sdk?.adv?.showFullscreenAdv({callbacks:{onClose:r=>{t||(t=!0,window.clearTimeout(a),e(!!r))},onError:()=>{t||(t=!0,window.clearTimeout(a),e(!1))}}})}catch(r){if(t)return;t=!0,window.clearTimeout(a),console.warn("[YandexService] showFullscreenAdv failed",r),e(!1)}})}async showRewarded(){return this.mockMode||!this.sdk?.adv?.showRewardedVideo?this.runMockRewarded():new Promise(e=>{let t=!1,a=!1;const r=window.setTimeout(()=>{a||(a=!0,e(!1))},12e3);try{this.sdk?.adv?.showRewardedVideo({callbacks:{onRewarded:()=>{t=!0},onClose:()=>{a||(a=!0,window.clearTimeout(r),e(t))},onError:()=>{a||(a=!0,window.clearTimeout(r),e(!1))}}})}catch(i){if(a)return;a=!0,window.clearTimeout(r),console.warn("[YandexService] showRewardedVideo failed",i),e(!1)}})}async loadJson(e,t){const a=await this.loadFromPlayer(e);if(a!==null)return a;const r=this.loadFromStorage(e);return r!==null?r:t}async saveJson(e,t){await this.saveToPlayer(e,t),this.saveToStorage(e,t)}async submitScore(e,t=n){if(this.mockMode||!this.sdk?.leaderboards?.setScore){this.saveMockLeaderboardScore(e);return}if(!(this.sdk.isAvailableMethod&&!this.sdk.isAvailableMethod("leaderboards.setScore")))try{await this.sdk.leaderboards.setScore(t,Math.max(0,Math.floor(e)))}catch(a){console.warn("[YandexService] setScore failed",a)}}async getLeaderboardTop(e=5,t=n){if(this.mockMode||!this.sdk?.leaderboards?.getEntries)return this.getMockLeaderboardRows(e);if(this.sdk.isAvailableMethod&&!this.sdk.isAvailableMethod("leaderboards.getEntries"))return[];try{return((await this.sdk.leaderboards.getEntries(t,{quantityTop:e,includeUser:!1})).entries??[]).slice(0,e).map((i,c)=>this.mapLeaderboardEntry(i,c))}catch(a){return console.warn("[YandexService] getEntries failed",a),[]}}trackEvent(e,t={}){const a={event:e,payload:t,timestamp:new Date().toISOString()};console.info("[Analytics event]",a),this.persistAnalyticsEvent(a);try{const r=window.ym;typeof r=="function"&&r(0,"reachGoal",e,t)}catch{}}mapLeaderboardEntry(e,t){return{rank:typeof e.rank=="number"?e.rank:t+1,score:typeof e.score=="number"?e.score:0,name:e.player?.publicName||"Player"}}async ensureSdkScriptLoaded(){if(typeof document>"u"||window.YaGames)return;if(document.querySelector('script[data-yandex-sdk="true"]')){await this.waitForYaGamesGlobal(5e3);return}await new Promise((t,a)=>{const r=document.createElement("script");r.src="/sdk.js",r.async=!0,r.dataset.yandexSdk="true",r.onload=()=>t(),r.onerror=()=>a(new Error("Failed to load /sdk.js")),document.head.appendChild(r)})}async waitForYaGamesGlobal(e){const t=Date.now();for(;!window.YaGames&&Date.now()-t<e;)await this.delay(100);return!!window.YaGames}enableMockMode(e){console.warn(`[YandexService] Mock mode enabled: ${e}`),this.mockMode=!0,this.initialized=!0}async runMockInterstitial(){return await this.delay(500),!0}async runMockRewarded(){return await this.delay(700),!0}async loadFromPlayer(e){if(!this.player)return null;try{const a=(await this.player.getData([e]))[e];return a??null}catch(t){return console.warn("[YandexService] player.getData failed",t),null}}async saveToPlayer(e,t){if(this.player)try{await this.player.setData({[e]:t},!0)}catch(a){console.warn("[YandexService] player.setData failed",a)}}loadFromStorage(e){try{const t=this.storage?.getItem(e)??window.localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return console.warn("[YandexService] storage read failed",t),null}}saveToStorage(e,t){const a=JSON.stringify(t);try{this.storage?.setItem(e,a)}catch(r){console.warn("[YandexService] safe storage write failed",r)}try{window.localStorage.setItem(e,a)}catch(r){console.warn("[YandexService] localStorage write failed",r)}}saveMockLeaderboardScore(e){try{const t=this.mockLeaderboardKey(),a=Number(window.localStorage.getItem(t)||"0"),r=Math.max(a,Math.floor(e));window.localStorage.setItem(t,String(r))}catch(t){console.warn("[YandexService] mock leaderboard write failed",t)}}getMockLeaderboardRows(e){try{const t=this.mockLeaderboardKey(),a=Number(window.localStorage.getItem(t)||"0"),r=[];for(a>0&&r.push({rank:1,score:a,name:"You (mock)"});r.length<Math.max(1,e);){const i=r.length+1;r.push({rank:i,score:Math.max(0,a-i*120),name:`Bot ${i}`})}return r.slice(0,e)}catch{return[]}}mockLeaderboardKey(){return`mock-lb:${n}`}persistAnalyticsEvent(e){try{const t=window.localStorage.getItem(s.ANALYTICS_STORAGE_KEY),a=t?JSON.parse(t):[];a.push(e),a.length>s.MAX_STORED_EVENTS&&a.splice(0,a.length-s.MAX_STORED_EVENTS),window.localStorage.setItem(s.ANALYTICS_STORAGE_KEY,JSON.stringify(a))}catch{}}async safeAwait(e){try{const t=e();return t?await t:void 0}catch{return}}delay(e){return new Promise(t=>{window.setTimeout(t,e)})}};s.ANALYTICS_STORAGE_KEY="triangle-arena-analytics-events-v1",s.MAX_STORED_EVENTS=80;let d=s;const p=new d;export{f as a,p as y};
